<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Play Novem</title>
  <meta name="description" content="Play Novem">
  <meta name="author" content="Satoshi Tanaka">
  <meta name="keywords" content="play,board game,game,novem">
  <style type="text/css">
    td.black_cell{
      border-top-color:black;
      border-left-color:black;
    }
    td.black_cell_r{
      border-top-color:black;
      border-right-color:black;
      border-left-color:black;
    }
    td.black_cell_b{
      border-top-color:black;
      border-bottom-color:black;
      border-left-color:black;
    }
    td.black_cell_br{
      border-top-color:black;
      border-bottom-color:black;
      border-right-color:black;
      border-left-color:black;
    }
  </style>
  <script src="https://d3js.org/d3.v4.min.js"></script>
</head>

<body>
  <h1>Play Novem</h1>

  <div id="home-view">
  <h2>Home</h2>
  <h3>Make a Room</h3>
  Enter your name, Row/Column, and handicap. <br>
  <input type="text" id="player-name" placeholder="Your Name" required minlength="1" maxlength="18" size="10">
  <select id="player-type">
    <option value="Row">Row Player</option>
    <option value="Column">Column Player</option>
  </select>
  <select id="player-handicap">
    <option value="-5">-5</option>
    <option value="-4">-4</option>
    <option value="-3" selected>-3</option>
    <option value="-2">-2</option>
    <option value="-1">-1</option>
    <option value="0">0</option>
    <option value="1">1</option>
    <option value="2">2</option>
  </select>
  <br>
  <button onclick="makeRoomRequest()">make a room</button>

  <h3>Join a Room</h3>””
  <h3>Room List</h3>
  <!-- created using javascript -->
  <ul id="room_list"></ul>

  <!-- end of home view -->
  </div>

  <!-- When playing, change to display -->
  <div id="playing-view" style="display:none">
  <!-- <div id="playing-view" style="display:block"> -->

  <h2>Playing</h2>
  <div id="playing-type">You are a player.</div>
  <div id="playing-rc"><strong>Select a Row.</strong></div>
  <div id="playing-round">Round: 1</div>
  <div id="playing-turn">You are Attacking</div>
  <div id="point-r">Your point = 0</div>
  <div id="point-c">Opponent point = 0</div>


  <div id="board">
    <table border="1" width="350" height="350" cellspacing="0" cellpadding="5" bordercolor="white">
      <tr id="board-head" align="center">
      <td width="50"></td>
      <td width="100"><button onclick="buttonClick('c', '1')">c1</button></td>
      <td width="100"><button onclick="buttonClick('c', '2')">c2</button></td>
      <td width="100"><button onclick="buttonClick('c', '3')">c3</button></td>
      </tr>
      <tr id="row1" align="center" height="100">
      <td><button onclick="buttonClick('r', '1')">r1</button></td>
      <td class="black_cell" id="cell00"></td>
      <td class="black_cell" id="cell01"></td>
      <td class="black_cell_r" id="cell02"></td>
      </tr>
      <tr id="row2" align="center" height="100">
      <td><button onclick="buttonClick('r', '1')">r2</button></td>
      <td class="black_cell" id="cell10"></td>
      <td class="black_cell" id="cell11"></td>
      <td class="black_cell_r" id="cell12"></td>
      </tr>
      <tr id="row3" align="center" height="100">
      <td><button onclick="buttonClick('r', '1')">r3</button></td>
      <td class="black_cell_b" id="cell20"></td>
      <td class="black_cell_b" id="cell21"></td>
      <td class="black_cell_br" id="cell22"></td>
      </tr>
      </table>
  </div>

  <!-- <div id="draw"><button>Draw</button></div> -->
  <hr>
  <div id="waiting">
    <img src="load.gif" width="30" height="30" alt="Loading..." /><br>
    Waiting for the opponen action.
  </div>

  <!-- end of playing view -->
  </div>


<script>
  function buttonClick(d, n){
    console.log(d+n);
  }

  function makeRoomList(data){
    console.log("make a room list!!");
    var room_list = document.getElementById("room_list");
    // room_list.remove();  // reset
    for (var room_id in data){
      if (room_id == "action"){
        continue;
      }
      var li = document.createElement("li");
      var text = "";
      for (var element in data[room_id]){
        text += element + "=" + data[room_id][element] + ", ";
      }
      li.appendChild(document.createTextNode(text));
      room_list.appendChild(li);
    }
  }

  function drawTile(tdId, bottom, top){
    // var svg = d3.select("#"+tdId).append("svg").attr("width", 100).attr("height", 100);
    var svg = d3.select("#"+tdId)
                .append("svg")
                .attr("width", 100)
                .attr("height", 100);
    // console.log(svg);
    if(bottom == 0){
      // do nothing. no tile
    } else if (top == 0){
      // only 1 tile.
      svg.append("rect")
        .attr("x", 20)
        .attr("y", 20)
        .attr("rx", 10)  // 丸角にする
        .attr("ry", 10)
        .attr("fill", "white")
        .attr("stroke", "black")
        .attr("width", 60)
        .attr("height", 60);
      svg.append("text")
        .attr("x", 35)
        .attr("y", 65)
        .attr("stroke", "black")
        .attr("font-size", 40)
        .text(bottom);
    }else{
      // 2 tiles.
      // d3.select("#"+tdId).append("svg").attr("width", 100).attr("height", 100)
      svg.append("rect")
        .attr("x", 25)
        .attr("y", 15)
        .attr("rx", 10)  // 丸角にする
        .attr("ry", 10)
        .attr("fill", "white")
        .attr("stroke", "black")
        .attr("width", 60)
        .attr("height", 60);
      svg.append("rect")
        .attr("x", 15)
        .attr("y", 25)
        .attr("rx", 10)  // 丸角にする
        .attr("ry", 10)
        .attr("fill", "white")
        .attr("stroke", "black")
        .attr("width", 60)
        .attr("height", 60);
      svg.append("text")
        .attr("x", 30)
        .attr("y", 70)
        .attr("stroke", "black")
        .attr("font-size", 40)
        .text(top);
    }
  }

  function switchToPlayingView(data){
    document.getElementById("playing-view").style.display ="block";
    document.getElementById("home-view").style.display ="none";

    // set the board
    bottom_board = [[0, 0, 0], [0, 0, 0], [0, 0, 0]];
    top_board = [[0, 0, 0], [0, 0, 0], [0, 0, 0]];
    var board = data["board"];
    for (var c in board){
      if (c < 9){  // bottom
        bottom_board[c/3|0][c%3] = board[c]
      }else{
        top_board[(c-9)/3|0][c%3] = board[c]
      }
    }
    // draw the board
    for (let i=0;i<3;i++){
      for(let j=0;j<3;j++){
        cell_id = "cell" + i + j;
        drawTile(cell_id, bottom_board[i][j], top_board[i][j]);
      }
    }
    // set player
    const player_type = document.getElementById("playing-type");
    player_type.innerHTML = "You are " + data["type"];
    //
    const player_rc = document.getElementById("playing-rc");
    if (data["type"] == "Row" || data["type"] == "Column"){
      player_rc.innerHTML = "<strong>Select a " + data["type"] + "</strong>";
    }else{
      player_rc.style.display = "none";
    }
    //
    const playing_round = document.getElementById("playing-round");
    var round = data["round"];
    playing_round.innerHTML = "Round: " + round;
    const playing_turn = document.getElementById("playing-turn");
    if((data["type"] == "Row" && round%2 == 0) || (data["type"] == "Column" && round%2 == 1)){
      playing_turn.innerHTML = "You are Attacking";
    }else{
      playing_turn.innerHTML = "You are Defending";
    }
    if(data["type"] == "Viewer"){
      if (round % 2 ==0){
        playing_turn.innerHTML = "Row is Attacking";
      }else{
        playing_turn.innerHTML = "Row is Attacking";
      }
    }
    //
    const point_r = document.getElementById("point-r");
    point_r.innerHTML = "Row point: " + data["row_point"];
    const point_c = document.getElementById("point-c");
    point_c.innerHTML = "Column point: " + data["column_point"];
    
    // waiting
    document.getElementById("waiting").style.display = "none";
  }

  // websocket
  var websocket = new WebSocket("ws://127.0.0.1:6789/");

  // send messages
  function makeRoomRequest() {
    console.log("make a room buttom is clicked");
    const player_name = document.getElementById("player-name").value;
    const player_type = document.getElementById("player-type").value;
    const player_handicap = document.getElementById("player-handicap").value;
    // console.log(player_name + player_type + player_handicap);
    websocket.send(JSON.stringify({action: "make-room", name: player_name, player_type: player_type, handicap: player_handicap}));
  }

  // receive messages
  websocket.onmessage = function (event) {
      data = JSON.parse(event.data);
      console.log("receive data. " + data);
      console.log(data);
      switch (data.action) {
          case 'playing':
            console.log("playing");
            switchToPlayingView(data);
            break;
          case 'room_list':
            console.log("receive room list");
            makeRoomList(data);
            break
          default:
            // console.log("unsupported event", data);
            console.error("unsupported event", data);
      }
  };
</script>

</body>
</html>
